<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Experiment – Sociální sítě</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 0;
      text-align: center;
    }

    .hidden { display: none; }

    .container {
      max-width: 700px;
      margin: 20px auto;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    button {
      padding: 12px 24px;
      font-size: 18px;
      border-radius: 12px;
      background: #4c8bf5;
      border: none;
      color: white;
      cursor: pointer;
    }

    button:hover { opacity: 0.9; }

    .video-wrapper {
      position: relative;
      width: 100%;
      height: 70vh;
      overflow: hidden;
      margin-bottom: 25px;
      border-radius: 18px;
      background: black;
    }

    .video-blur {
      position: absolute;
      width: 120%;
      height: 120%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      object-fit: cover;
      filter: blur(25px) brightness(0.7);
      z-index: 1;
    }

    .video-main {
      position: relative;
      width: 100%;
      height: 100%;
      object-fit: contain;
      z-index: 2;
    }

    #screen-task h3 { font-size: 28px; margin-bottom: 5px; }
    #task-timer { font-weight: bold; }
    #task-content { margin-top: 40px; text-align: center; font-size: 22px; line-height: 1.4; }

    .task-item p { margin-bottom: 25px; }

    #task-answer {
      width: 200px;
      padding: 12px 14px;
      font-size: 20px;
      border-radius: 10px;
      border: 1px solid #ccc;
      text-align: center;
      margin-bottom: 25px;
    }

    #present-options button {
      margin: 12px;
      padding: 14px 28px;
      font-size: 20px;
      border-radius: 14px;
    }
  </style>
</head>
<body>

  <!-- ÚVOD -->
  <div id="screen-intro" class="container">
    <h2>Výzkum používání sociálních sítí</h2>
    <p>Dobrý den, děkuji vám za účast...</p>
    <button onclick="startExperiment()">Začít</button>
  </div>

  <!-- EXPOZICE -->
  <div id="screen-exposure" class="container hidden">
    <h3 id="exposure-description">Načítám…</h3>
    <p>Zbývající čas: <span id="exposure-timer">120</span> sekund</p>

    <div id="exp-feed" class="feed-container hidden" style="height: 90vh; overflow-y: scroll; background:#000; border-radius:18px; padding:0; margin-top:20px;">
      <div class="video-wrapper">
        <video class="video-blur" src="short2.mp4" muted playsinline></video>
        <video class="video-main" src="short2.mp4" muted playsinline></video>
      </div>
      <div class="video-wrapper">
        <video class="video-blur" src="short3.mp4" muted playsinline></video>
        <video class="video-main" src="short3.mp4" muted playsinline></video>
      </div>
      <div class="video-wrapper">
        <video class="video-blur" src="short4.mp4" muted playsinline></video>
        <video class="video-main" src="short4.mp4" muted playsinline></video>
      </div>
      <div class="video-wrapper">
        <video class="video-blur" src="short5.mp4" muted playsinline></video>
        <video class="video-main" src="short5.mp4" muted playsinline></video>
      </div>
      <div class="video-wrapper">
        <video class="video-blur" src="short6.mp4" muted playsinline></video>
        <video class="video-main" src="short6.mp4" muted playsinline></video>
      </div>
    </div>

    <div id="ctrl-text" class="hidden" style="text-align:left; padding:20px; background:white; border-radius:12px; margin-top:20px;">
      <h3>Neutrální text</h3>
      <p>Mosty patří mezi základní technické stavby...</p>
    </div>
  </div>

  <!-- LATENCE -->
  <div id="screen-latency" class="container hidden">
    <h3>Klikněte na tlačítko pro zahájení úkolu</h3>
    <button onclick="startTask()">Začít úkol</button>
  </div>

  <!-- ÚKOL -->
  <div id="screen-task" class="container hidden">
    <h3>Úkol</h3>
    <p>Zbývající čas: <span id="task-timer">180</span> sekund</p>
    <div id="task-content" style="margin-top:20px;"></div>
    <button onclick="submitAnswer()">Odeslat odpověď</button>
  </div>

  <!-- MINI EXPERIMENT -->
  <div id="screen-present" class="container hidden">
    <h3>Mini-experiment – preference odměn</h3>
    <p id="present-question" style="font-size:20px;"></p>
    <p id="present-progress" style="margin-top:8px; color:#666;"></p>
    <div id="present-options" style="margin-top:20px;"></div>
  </div>

  <!-- KONEC -->
  <div id="screen-end" class="container hidden">
    <h3>Děkujeme za účast</h3>
    <p>Kód respondenta: <b id="code-box"></b></p>
    <p>Skupina: <span id="summary-group"></span></p>
    <p>Čas otálení před úkolem: <span id="summary-latency"></span> s</p>
    <p>Správné odpovědi v úkolu: <span id="summary-score"></span></p>
    <p>Voleb „hned teď“ v mini-experimentu: <span id="summary-bias"></span></p>
  </div>

<script>
const SHEET_URL = "https://script.google.com/macros/s/AKfycbyvHZXK4_sEUvdYH8w3LYIu3hjLAoxBq8qfjiDymlMNgFoURO2nZBcomnZa8Iry6_px/exec";

const EXPOSURE_SECONDS = 120;
const TASK_SECONDS = 180;

const TASKS = [
  { text: "V obchodě mají balení tužek po 4 kusech...", correct: 12 },
  { text: "V krabici je 15 jablek...", correct: 11 },
  { text: "Tomáš běžel 20 minut...", correct: 35 },
  { text: "Ve třídě je 26 žáků...", correct: 44 },
  { text: "V balení je 6 lahví...", correct: 42 }
];

const PRESENT_CHOICES = [
  { prompt: "Představte si...", now: "A) 200 Kč dnes", later: "B) 260 Kč za 7 dní" },
  { prompt: "Spíše menší...", now: "A) 300 Kč dnes", later: "B) 380 Kč za 14 dní" },
  { prompt: "Malá jistá radost...", now: "A) 150 Kč dnes", later: "B) 230 Kč za 7 dní" },
  { prompt: "Jednorázový bonus...", now: "A) 500 Kč dnes", later: "B) 710 Kč za 30 dní" },
  { prompt: "Na závěr...", now: "A) 80 Kč dnes", later: "B) 140 Kč za 7 dní" }
];

let group = null;
let exposureRemaining = EXPOSURE_SECONDS;
let taskRemaining = TASK_SECONDS;
let latencyStart = null;
let latencyMs = 0;
let currentTask = 0;
let correctCount = 0;
let biasIndex = 0;
let biasImmediate = 0;
let participantID = null;

// --- VIDEO LOGIKA ---
document.addEventListener("DOMContentLoaded", () => {
  const feedVideos = document.querySelectorAll("#exp-feed .video-main");

  function pauseAll() {
    feedVideos.forEach(v => v.pause());
  }

  if (feedVideos.length > 0 && "IntersectionObserver" in window) {
    const observer = new IntersectionObserver(entries => {
      entries.forEach(e => {
        if (e.isIntersecting) {
          pauseAll();
          e.target.play().catch(()=>{});
        }
      });
    }, { threshold: 0.6 });

    feedVideos.forEach(v => observer.observe(v));

    feedVideos.forEach((v,i)=>{
      v.addEventListener("ended",()=>{
        const next = feedVideos[i+1];
        if(next){
          next.scrollIntoView({behavior:"smooth",block:"center"});
          setTimeout(()=>{ pauseAll(); next.play().catch(()=>{}); },600);
        }
      });
    });
  }
});

// --- PŘEPÍNÁNÍ OBRAZOVEK ---
function show(id) {
  ["screen-intro","screen-exposure","screen-latency","screen-task","screen-present","screen-end"].forEach(s=>{
    document.getElementById(s).classList.add("hidden");
  });
  document.getElementById(id).classList.remove("hidden");
}

// --- RANDOMIZACE ---
function startExperiment() {
  group = Math.random() < 0.5 ? "exp" : "ctrl";
  show("screen-exposure");

  if (group === "exp") {
    document.getElementById("exp-feed").classList.remove("hidden");
    document.getElementById("ctrl-text").classList.add("hidden");
    document.getElementById("exposure-description").textContent = "Prohlížejte prosím feed videí po dobu 2 minut.";
  } else {
    document.getElementById("ctrl-text").classList.remove("hidden");
    document.getElementById("exp-feed").classList.add("hidden");
    document.getElementById("exposure-description").textContent = "Čtěte prosím text po dobu 2 minut.";
  }

  const t = document.getElementById("exposure-timer");
  exposureRemaining = EXPOSURE_SECONDS;
  t.textContent = exposureRemaining;

  const interval = setInterval(()=>{
    exposureRemaining--;
    t.textContent = exposureRemaining;

    if (exposureRemaining <= 0) {
      clearInterval(interval);
      show("screen-latency");
      latencyStart = performance.now();
    }
  },1000);
}

// --- START ÚKOLU ---
function startTask() {
  latencyMs = performance.now() - latencyStart;
  show("screen-task");

  taskRemaining = TASK_SECONDS;
  currentTask = 0;
  correctCount = 0;

  const timer = document.getElementById("task-timer");
  timer.textContent = taskRemaining;

  renderTask();

  const interval = setInterval(()=>{
    taskRemaining--;
    timer.textContent = taskRemaining;

    if (taskRemaining <= 0) {
      clearInterval(interval);
      endTask();
    }
  },1000);
}

// --- MATEMATICKÝ ÚKOL ---
function renderTask() {
  const c = document.getElementById("task-content");
  c.innerHTML = "";

  if (currentTask >= TASKS.length) {
    endTask();
    return;
  }

  const t = TASKS[currentTask];
  c.innerHTML = `<div class="task-item"><p>${t.text}</p><input id="task-answer" type="number"></div>`;
  const inp = document.getElementById("task-answer");
  if (inp) inp.focus();
}

function submitAnswer() {
  const inp = document.getElementById("task-answer");
  if (!inp) return;

  const val = parseInt(inp.value,10);
  const t = TASKS[currentTask];

  if (!isNaN(val) && val === t.correct) correctCount++;

  currentTask++;
  if (currentTask < TASKS.length && taskRemaining > 0) renderTask();
  else endTask();
}

// --- PRESENT BIAS ---
function endTask() {
  show("screen-present");
  biasIndex = 0;
  biasImmediate = 0;
  renderPresentChoice();
}

function renderPresentChoice() {
  const total = PRESENT_CHOICES.length;

  if (biasIndex >= total) {
    finishAll();
    return;
  }

  const ch = PRESENT_CHOICES[biasIndex];
  document.getElementById("present-question").textContent = ch.prompt;
  document.getElementById("present-progress").textContent = `Volba ${biasIndex+1} z ${total}`;

  document.getElementById("present-options").innerHTML = `
    <button onclick="chooseImmediate()">${ch.now}</button>
    <button onclick="chooseDelayed()">${ch.later}</button>
  `;
}

function chooseImmediate() {
  biasImmediate++;
  biasIndex++;

  if (biasIndex >= PRESENT_CHOICES.length) {
    finishAll();
    return;
  }

  renderPresentChoice();
}

function chooseDelayed() {
  biasIndex++;

  if (biasIndex >= PRESENT_CHOICES.length) {
    finishAll();
    return;
  }

  renderPresentChoice();
}


// --- ZÁVĚR + ODESLÁNÍ ---
function finishAll() {
  participantID = genID(6);

  document.getElementById("code-box").textContent = participantID;
  document.getElementById("summary-group").textContent = group === "exp" ? "experimentální" : "kontrolní";
  document.getElementById("summary-latency").textContent = (latencyMs/1000).toFixed(2);
  document.getElementById("summary-score").textContent = correctCount;
  document.getElementById("summary-bias").textContent = `${biasImmediate} / ${PRESENT_CHOICES.length}`;

  sendToSheet();
  show("screen-end");
}

function genID(len) {
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let out = "";
  for (let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
  return out;
}

function sendToSheet() {
  const payload = {
    participant_id: participantID,
    group: group,
    latency_seconds: latencyMs/1000,
    correct_answers: correctCount,
    present_bias_score: biasImmediate
  };

  fetch(SHEET_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(()=>console.log("Odesláno"))
  .catch(e=>console.error("Chyba při odesílání: ",e));
}

window.startExperiment = startExperiment;
window.startTask = startTask;
window.submitAnswer = submitAnswer;
window.chooseImmediate = chooseImmediate;
window.chooseDelayed = chooseDelayed;
</script>
</body>
</html>
